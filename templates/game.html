<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tic-Tac-Toe</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { display: flex; justify-content: center; align-items: flex-start; margin-top: 30px; }
        .game-area { flex: 0 0 300px; }
        .board { display: grid; grid-template-columns: repeat(3, 80px); grid-gap: 5px; margin: 0 auto 20px auto; width: 255px; }
        .cell { width: 80px; height: 80px; font-size: 2.5em; cursor: pointer; background: #f0f0f0; border: 2px solid #333; }
        .cell:disabled { background: #ddd; cursor: not-allowed; }
        .info { margin: 20px; font-size: 1.2em; }
        .reset-btn { margin-top: 20px; padding: 8px 20px; font-size: 1em; }
        .chatroom { flex: 0 0 320px; margin-left: 40px; background: #fafafa; border: 1px solid #ccc; border-radius: 8px; padding: 16px; box-shadow: 0 2px 8px #eee; }
        .chat-messages { height: 320px; overflow-y: auto; border: 1px solid #ddd; background: #fff; padding: 8px; margin-bottom: 12px; border-radius: 4px; text-align: left; }
        .chat-input-area { display: flex; }
        .chat-input { flex: 1; padding: 6px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc; }
        .chat-send { margin-left: 8px; padding: 6px 16px; font-size: 1em; border-radius: 4px; border: none; background: #333; color: #fff; cursor: pointer; }
        .chat-send:hover { background: #ffd600; color: #333; border-color: #ffd600; }
        .chat-send:disabled { background: #aaa; cursor: not-allowed; }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container">
        <div class="game-area">
            <div class="info">
                {% if winner %}
                    {% if winner == 'Draw' %}
                        <b>It's a Draw!</b>
                    {% else %}
                        <b>Winner: {{ winner }}</b>
                    {% endif %}
                {% else %}
                    Turn: <b>{{ turn }}</b>
                {% endif %}
            </div>
            <div class="mode-select">
                <form method="post" id="mode-form">
                    <label>
                        <input type="radio" name="mode" value="computer" {% if mode == 'computer' %}checked{% endif %}> é›»è…¦å°æˆ°
                    </label>
                    <select name="difficulty">
                        <option value="simple" {% if difficulty == 'simple' %}selected{% endif %}>ç°¡å–®</option>
                        <option value="normal" {% if difficulty == 'normal' %}selected{% endif %}>æ™®é€š</option>
                        <option value="hard" {% if difficulty == 'hard' %}selected{% endif %}>å›°é›£</option>
                    </select>
                    <label>
                        <input type="radio" name="mode" value="pvp" {% if mode == 'pvp' %}checked{% endif %}> ç©å®¶å°æˆ°
                    </label>
                    <button type="submit" name="action" value="set_mode">è¨­å®šæ¨¡å¼</button>
                </form>
                {% if mode == 'pvp' %}
                    <div id="pvp-status"></div>
                {% endif %}
            </div>
            
            {% if mode == 'computer' %}
                {# Computer mode #}
                {% if not started %}
                    <div style="margin:16px">
                        <p><b>è«‹å…ˆé¸æ“‡ éŠæˆ²æ¨¡å¼ï¼Œç„¶å¾ŒæŒ‰ã€Œé–‹å§‹éŠæˆ²ã€é€²å…¥éŠæˆ²ç•«é¢ã€‚</b></p>
                        <form method="post">
                            <button type="submit" name="action" value="start_game">é–‹å§‹éŠæˆ²</button>
                        </form>
                    </div>
                {% else %}
                    <form method="post">
                        <div class="board">
                            {% for i in range(9) %}
                                <button class="cell" name="cell" value="{{ i }}" {% if board[i] or winner %}disabled{% endif %}>
                                    {{ board[i] if board[i] else '' }}
                                </button>
                            {% endfor %}
                        </div>
                    </form>
                    <button class="reset-btn" id="reset-btn" type="button" onclick="window.location.href='{{ url_for('reset') }}'">Restart Game</button>
                {% endif %}
            {% else %}
                {# PvP mode #}
                <div style="margin:16px">
                    {% if not started %}
                        <p><b>è«‹æŒ‰ã€Œé–‹å§‹é…å°ã€å°‹æ‰¾å°æ‰‹ã€‚</b></p>
                        <button id="start-pvp-btn" type="button">é–‹å§‹é…å°</button>
                    {% endif %}
                </div>
                <div class="board" id="game-board" {% if not started %}style="display:none;"{% endif %}>
                    {% for i in range(9) %}
                        <button class="cell" data-cell="{{ i }}" {% if board[i] or winner %}disabled{% else %}{% if not started %}disabled{% endif %}{% endif %}>
                            {{ board[i] if board[i] else '' }}
                        </button>
                    {% endfor %}
                </div>
                <button class="reset-btn" id="reset-btn" type="button" style="{% if not started %}display:none;{% endif %}">Restart Game</button>
            {% endif %}
        </div>
        {% if mode != 'computer' %}
        <div class="chatroom">
            <h2>èŠå¤©å®¤</h2>
            <div id="chat-messages" class="chat-messages"></div>
            <div class="chat-input-area">
                <input id="chat-input" class="chat-input" type="text" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off" />
                <button id="chat-send" class="chat-send">é€å‡º</button>
            </div>
        </div>
        {% endif %}
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const mode = "{{ mode }}";
        const gameBoard = document.getElementById('game-board');
        const pvpStatus = document.getElementById('pvp-status');
        const startPvpBtn = document.getElementById('start-pvp-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        let mySymbol = null;
        let currentTurn = 'X';
        let gameActive = false;

        function appendMessage(msg) {
            if (chatMessages) {
                const div = document.createElement('div');
                div.textContent = msg;
                chatMessages.appendChild(div);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        if (chatSend) {
            chatSend.onclick = function(e) {
                e.preventDefault();
                const msg = chatInput.value.trim();
                if (msg) {
                    socket.emit('chat message', msg);
                    chatInput.value = '';
                }
            };
        }
        
        if (chatInput) {
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    chatSend.click();
                }
            });
        }

        socket.on('chat message', function(msg) {
            appendMessage(msg);
        });

        // PvP game logic
        if (mode === 'pvp') {
            if (startPvpBtn) {
                startPvpBtn.onclick = function() {
                    socket.emit('join_pvp');
                    startPvpBtn.disabled = true;
                    startPvpBtn.textContent = 'é…å°ä¸­...';
                    if (pvpStatus) pvpStatus.textContent = 'æ­£åœ¨å°‹æ‰¾å°æ‰‹...';
                };
            }

            socket.on('waiting_for_opponent', function(data) {
                if (pvpStatus) pvpStatus.innerHTML = '<b>ç­‰å¾…å°æ‰‹åŠ å…¥...</b>';
                mySymbol = 'X';  // First player is always X
            });

            socket.on('game_start', function(data) {
                if (pvpStatus) {
                    pvpStatus.innerHTML = '<b>éŠæˆ²é–‹å§‹ï¼</b><br>' + 
                        data.players.map(p => `${p.username} (${p.symbol})`).join(' vs ');
                }
                // Server tells us our symbol
                mySymbol = data.your_symbol;
                
                currentTurn = data.turn;
                gameActive = true;
                
                // Show the game board and reset button
                if (gameBoard) {
                    gameBoard.style.display = 'grid';
                }
                if (resetBtn) {
                    resetBtn.style.display = 'inline-block';
                }
                
                updateBoard(data.board);
                updateTurnDisplay();
            });

            socket.on('game_update', function(data) {
                updateBoard(data.board);
                currentTurn = data.turn;
                
                if (data.winner) {
                    gameActive = false;
                    const infoDiv = document.querySelector('.info');
                    if (data.winner === 'Draw') {
                        if (pvpStatus) pvpStatus.innerHTML = '<b>å¹³æ‰‹ï¼</b>';
                        if (infoDiv) infoDiv.innerHTML = '<b>å¹³æ‰‹ï¼</b>';
                    } else {
                        if (pvpStatus) pvpStatus.innerHTML = `<b>è´å®¶: ${data.winner}</b>`;
                        if (infoDiv) {
                            if (data.winner === mySymbol) {
                                infoDiv.innerHTML = '<b style="color: green;">ä½ è´äº†ï¼ğŸ‰</b>';
                            } else {
                                infoDiv.innerHTML = '<b style="color: red;">ä½ è¼¸äº†ï¼</b>';
                            }
                        }
                    }
                    // Disable all cells when game ends
                    if (gameBoard) {
                        const cells = gameBoard.querySelectorAll('.cell');
                        cells.forEach(cell => cell.disabled = true);
                    }
                } else {
                    // Game continues, update turn display
                    gameActive = true;
                    updateTurnDisplay();
                }
            });

            socket.on('opponent_left', function() {
                if (pvpStatus) pvpStatus.innerHTML = '<b>å°æ‰‹å·²é›¢é–‹</b>';
                gameActive = false;
            });

            // Handle cell clicks for PvP
            if (gameBoard) {
                gameBoard.addEventListener('click', function(e) {
                    if (e.target.classList.contains('cell')) {
                        const cell = parseInt(e.target.dataset.cell);
                        if (gameActive && currentTurn === mySymbol && !e.target.disabled) {
                            socket.emit('make_move', { cell: cell });
                        }
                    }
                });
            }

            // Handle reset button for PvP
            if (resetBtn) {
                resetBtn.onclick = function() {
                    socket.emit('reset_game');
                    gameActive = true;
                    updateTurnDisplay();
                };
            }

            function updateBoard(board) {
                if (!gameBoard) return;
                const cells = gameBoard.querySelectorAll('.cell');
                cells.forEach((cell, index) => {
                    cell.textContent = board[index] || '';
                    cell.disabled = board[index] !== null;
                });
            }

            function updateTurnDisplay() {
                const infoDiv = document.querySelector('.info');
                if (infoDiv && gameActive) {
                    if (currentTurn === mySymbol) {
                        infoDiv.innerHTML = '<b style="color: green;">è¼ªåˆ°ä½ äº†ï¼</b>';
                    } else {
                        infoDiv.innerHTML = '<b>ç­‰å¾…å°æ‰‹...</b>';
                    }
                }
            }
        }
        // Note: Computer mode doesn't need JavaScript for reset button, 
        // it's handled by inline onclick in the template
    </script>
</body>
</html>
