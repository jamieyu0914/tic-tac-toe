<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tic-Tac-Toe</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container">                                                                                                                                                                                                                                                                                                                                                                                                                                                         
        <div class="game-area">
            <div class="info">
                {% if winner %} <!-- éŠæˆ²çµæŸ -->
                    {% if winner == 'Draw' %}
                        <b>å¹³æ‰‹!</b>
                    {% else %} <!-- æœ‰è´å®¶ -->
                        <b>è´å®¶: 
                            {{ winner }}
                        </b>
                    {% endif %}
                {% elif started %} <!-- éŠæˆ²é€²è¡Œä¸­ -->
                    è¼ªåˆ°: <b>{{ turn }}</b>
                {% endif %}
            </div>
                {# PvP mode #}
                <div class="pvp-info" style="margin:16px">
                    <div class="pvp-search">
                        <p><b>è«‹æŒ‰ã€Œé–‹å§‹é…å°ã€å°‹æ‰¾å°æ‰‹ã€‚</b></p>
                        <button id="start-pvp-btn" type="button" onclick="startPvp()">é–‹å§‹é…å°</button>
                    </div>
                    <span id="pvp-status"></span>
                    <div id="pvp-score" style="margin-top:8px; font-weight:bold;"></div>
                    <div id="pvp-players" style="margin-top:8px;"></div>
                </div>
                <div class="board" id="game-board" {% if not started %}style="display:none;"{% endif %}>
                    {% for i in range(9) %}
                        <button class="cell" data-cell="{{ i }}" {% if board[i] or winner %}disabled{% else %}{% if not started %}disabled{% endif %}{% endif %}>
                            {{ board[i] if board[i] else '' }}
                        </button>
                    {% endfor %}
                </div>
                {% if not started %}
                    <button class="reset-btn" id="reset-btn" type="button" style="display:none;" onclick="resetGame()">é‡æ–°é–‹å§‹éŠæˆ²</button>
                {% else %}
                    <button class="reset-btn" id="reset-btn" type="button" onclick="resetGame()">é‡æ–°é–‹å§‹éŠæˆ²</button>
                {% endif %}
        </div>
        <div class="chatroom">
            <h2>èŠå¤©å®¤</h2>
            <div id="chat-messages" class="chat-messages"></div>
            <div class="chat-input-area">
                <input id="chat-input" class="chat-input" type="text" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off" />
                <button id="chat-send" class="chat-send" onclick="sendMessage()">é€å‡º</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const mode = "{{ mode }}";
        const gameBoard = document.getElementById('game-board');
        const pvpStatus = document.getElementById('pvp-status');
        const startPvpBtn = document.getElementById('start-pvp-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        let mySymbol = null;
        let currentTurn = 'X';
        let gameActive = false;
        let myWins = 0;
        let myLosses = 0;
        let roundCount = 0;
        let mySide = null; // 'left' or 'right'
        let leftPlayer = null;
        let rightPlayer = null;
        let leftWins = 0;
        let rightWins = 0;
        let leftDraws = 0;
        let rightDraws = 0;

        function appendMessage(msg) {
            if (chatMessages) {
                const div = document.createElement('div');
                div.textContent = msg;
                chatMessages.appendChild(div);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function sendMessage() {
            const msg = chatInput.value.trim();
            if (msg) {
                socket.emit('chat message', msg);
                chatInput.value = '';
            }
        }
        
        if (chatInput) {
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    chatSend.click();
                }
            });
        }

        socket.on('chat message', function(msg) {
            appendMessage(msg);
        });

        // PvP game logic
        function startPvp() {
            socket.emit('join_pvp');
            startPvpBtn.disabled = true;
            startPvpBtn.textContent = 'é…å°ä¸­...';
            if (pvpStatus) pvpStatus.textContent = 'æ­£åœ¨å°‹æ‰¾å°æ‰‹...';
        }

        function resetGame() {
            socket.emit('reset_game');
            gameActive = true;
            updateTurnDisplay();
        }

        if (mode === 'pvp') {

            socket.on('waiting_for_opponent', function(data) {
                if (pvpStatus) pvpStatus.innerHTML = '<b>ç­‰å¾…å°æ‰‹åŠ å…¥...</b>';
                mySymbol = 'X';  // First player is always X
            });

            socket.on('game_start', function(data) {
                if (pvpStatus) {
                    document.querySelector('.pvp-search').style.display = 'none';
                }
                // éš¨æ©Ÿåˆ†é…å·¦å³ï¼Œå·¦ç©å®¶å…ˆæ‰‹
                // ä¼ºæœå™¨éœ€å‚³é left_player, right_player, my_side
                leftPlayer = data.left_player;
                rightPlayer = data.right_player;
                mySide = data.my_side; // 'left' or 'right'
                mySymbol = data.your_symbol;
                currentTurn = data.turn;
                gameActive = true;
                // Show the game board and reset button
                if (gameBoard) {
                    gameBoard.style.display = 'grid';
                }
                if (resetBtn) {
                    resetBtn.style.display = 'inline-block';
                }
                updateBoard(data.board);
                updateTurnDisplay();
                updateScoreDisplay();
                updatePlayersDisplay();
            });

            socket.on('game_update', function(data) {
                updateBoard(data.board);
                currentTurn = data.turn;
                if (data.winner) {
                    gameActive = false;
                    roundCount++;
                    const infoDiv = document.querySelector('.info');
                    if (data.winner === 'Draw') {
                        if (pvpStatus) pvpStatus.innerHTML = '<b>å¹³æ‰‹ï¼</b>';
                        if (infoDiv) infoDiv.innerHTML = '<b>å¹³æ‰‹ï¼</b>';
                        leftDraws++;
                        rightDraws++;
                    } else {
                        if (pvpStatus) pvpStatus.innerHTML = `<b>è´å®¶: ${data.winner}</b>`;
                        if (infoDiv) {
                            if (mySide === 'left' && data.winner === 'X') {
                                infoDiv.innerHTML = '<b style="color: green;">ä½ è´äº†ï¼ğŸ‰</b>';
                                myWins++;
                                leftWins++;
                            } else if (mySide === 'right' && data.winner === 'O') {
                                infoDiv.innerHTML = '<b style="color: green;">ä½ è´äº†ï¼ğŸ‰</b>';
                                myWins++;
                                rightWins++;
                            } else {
                                infoDiv.innerHTML = '<b style="color: red;">ä½ è¼¸äº†ï¼</b>';
                                myLosses++;
                                if (mySide === 'left') rightWins++;
                                else leftWins++;
                            }
                        }
                    }
                    // Disable all cells when game ends
                    if (gameBoard) {
                        const cells = gameBoard.querySelectorAll('.cell');
                        cells.forEach(cell => cell.disabled = true);
                    }
                    updateScoreDisplay();
                    updatePlayersDisplay();
                } else {
                    // Game continues, update turn display
                    gameActive = true;
                    updateTurnDisplay();
                }
            });

            socket.on('opponent_left', function() {
                if (pvpStatus) pvpStatus.innerHTML = '<b>å°æ‰‹å·²é›¢é–‹</b>';
                gameActive = false;
                // è®“é…å°æŒ‰éˆ•æ¢å¾©å¯ç”¨
                if (startPvpBtn) {
                    startPvpBtn.disabled = false;
                    startPvpBtn.textContent = 'é–‹å§‹é…å°';
                }
                // ç¦ç”¨æ£‹ç›¤
                if (gameBoard) {
                    const cells = gameBoard.querySelectorAll('.cell');
                    cells.forEach(cell => {
                        cell.disabled = true;
                        cell.textContent = '';
                    });
                    gameBoard.style.display = 'none'; // éš±è—æ£‹ç›¤
                }
                // éš±è—é‡æ–°é–‹å§‹æŒ‰éˆ•
                if (resetBtn) {
                    resetBtn.style.display = 'none';
                }
                // é¡¯ç¤ºç³»çµ±è¨Šæ¯
                appendMessage('[ç³»çµ±æç¤º] æ‚¨çš„å°æ‰‹è½è’è€Œé€ƒï¼ŒéŠæˆ²çµæŸã€‚');
                // æ›´æ–° info å€å¡Š
                const infoDiv = document.querySelector('.info');
                if (infoDiv) infoDiv.innerHTML = '';
            });

            // Handle cell clicks for PvP
            if (gameBoard) {
                gameBoard.addEventListener('click', function(e) {
                    if (e.target.classList.contains('cell')) {
                        const cell = parseInt(e.target.dataset.cell);
                        if (gameActive && currentTurn === mySymbol && !e.target.disabled) {
                            socket.emit('make_move', { cell: cell });
                        }
                    }
                });
            }

            function updateBoard(board) {
                if (!gameBoard) return;
                const cells = gameBoard.querySelectorAll('.cell');
                cells.forEach((cell, index) => {
                    cell.textContent = board[index] || '';
                    cell.disabled = board[index] !== null;
                });
            }

            function updateTurnDisplay() {
                const infoDiv = document.querySelector('.info');
                if (infoDiv && gameActive) {
                    if (currentTurn === mySymbol) {
                        infoDiv.innerHTML = '<b style="color: green;">è¼ªåˆ°ä½ äº†ï¼</b>';
                    } else {
                        infoDiv.innerHTML = '<b>ç­‰å¾…å°æ‰‹...</b>';
                    }
                }
            }

            function updateScoreDisplay() {
                const scoreDiv = document.getElementById('pvp-score');
                if (scoreDiv) {
                    scoreDiv.innerHTML = `å›åˆåˆ¶ï¼š5æˆ°3å‹ï½œç›®å‰å›åˆï¼š${roundCount}`;
                }
            }

            function updatePlayersDisplay() {
                const playersDiv = document.getElementById('pvp-players');
                if (playersDiv) {
                    playersDiv.innerHTML =
                        `<span class="left-player">å·¦ç©å®¶ï¼š${leftWins}</span>ï½œå¹³æ‰‹ï¼š${leftDraws}` +
                        'ï½œ' +
                        `<span class="right-player">å³ç©å®¶ï¼š${rightWins}</span>`;
                }
            }
        }
    </script>
</body>
</html>
